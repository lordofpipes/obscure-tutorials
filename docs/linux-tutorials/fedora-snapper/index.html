<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Tutorial for setting up a Fedora installation that can do whole-system rollbacks"><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="How to install Fedora Minimal with Snapper"><meta property="og:description" content="Tutorial for setting up a Fedora installation that can do whole-system rollbacks"><meta property="og:type" content="article"><meta property="og:url" content="https://lordofpipes.github.io/obscure-tutorials/docs/linux-tutorials/fedora-snapper/"><meta property="og:image" content="https://lordofpipes.github.io/obscure-tutorials/img/fedora-snapper/31-grub-menu.png"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2022-11-16T00:00:00+00:00"><title>How to install Fedora Minimal with Snapper | lordpipe's Obscure Tutorials</title><link rel=manifest href=/obscure-tutorials/manifest.json><link rel=icon href=/obscure-tutorials/favicon.png type=image/x-icon><link rel=stylesheet href=/obscure-tutorials/book.min.500cfc5bf3d4c843f7b8f32c7c407090b8a7cb4e7dae5812a993d2418d268863.css integrity="sha256-UAz8W/PUyEP3uPMsfEBwkLiny059rlgSqZPSQY0miGM=" crossorigin=anonymous><script defer src=/obscure-tutorials/flexsearch.min.js></script>
<script defer src=/obscure-tutorials/en.search.min.6f7142a70aa31e445140f3c81878ba3f3dc13109a71f4cac9cb0809298388ba9.js integrity="sha256-b3FCpwqjHkRRQPPIGHi6Pz3BMQmnH0ysnLCAkpg4i6k=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/obscure-tutorials/><span>lordpipe's Obscure Tutorials</span></a></h2></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/obscure-tutorials/svg/menu.svg class=book-icon alt=Menu></label>
<strong>How to install Fedora Minimal with Snapper</strong>
<label for=toc-control><img src=/obscure-tutorials/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#snapper-but-what-about-silverblue>Snapper? But what about Silverblue?</a><ul><li><a href=#rpm-ostree>rpm-ostree?</a></li><li><a href=#flatpak>Flatpak?</a></li><li><a href=#linux-ricers-and-ridding-your-system-of-bloat>Linux Ricers, and ridding your system of bloat</a></li></ul></li><li><a href=#snapper>Snapper</a></li><li><a href=#tutorial-set-up-a-fedora-minimal-installation-with-snapper>Tutorial: Set up a Fedora Minimal installation with Snapper</a><ul><li><a href=#ssh-daemon-optional>SSH daemon [OPTIONAL]</a></li><li><a href=#shell-ricing-optional>Shell ricing [OPTIONAL]</a></li><li><a href=#installing-snapper-and-setting-up-grub-integration>Installing Snapper and setting up Grub integration</a></li><li><a href=#using-snapper>Using Snapper</a></li><li><a href=#ricing-an-x11-desktop-optional>Ricing an X11 desktop [OPTIONAL]</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1><a href=/obscure-tutorials/docs/linux-tutorials/fedora-snapper/>How to install Fedora Minimal with Snapper</a></h1><h5>2022-11-16</h5><p><strong>The goal:</strong> Get a &ldquo;riceable&rdquo; Linux setup that can be rolled back in a flexible manner, by running a clever OpenSUSE tool on a non-OpenSUSE distro. Make a system that is difficult to break in a way that will waste a whole day getting it working again. All the fun of Linux desktop ricing, but none of the risk.</p><p><a href=#snapper>Skip introduction</a></p><h2 id=snapper-but-what-about-silverblue>Snapper? But what about Silverblue?
<a class=anchor href=#snapper-but-what-about-silverblue>#</a></h2><p><a href=https://silverblue.fedoraproject.org/>Silverblue</a> is a fantastic project that intends to introduce the concept of immutable operating systems to the Linux desktop and server. It does this by packaging an entire set of operating system files together, updating it all at once when you reboot the system. Currently, there are four OSTree-based projects, one that includes system files for GNOME desktop (Silverblue), another that provides system files for a <a href=https://kinoite.fedoraproject.org/>KDE desktop (Kinoite)</a>, as well as an IoT platform (Fedora IoT) and a headless container platform (CoreOS).</p><p>This system is broadly similar to how Windows, Android, macOS, and iOS work.</p><p><strong>Analogy: Windows Update</strong></p><figure class=align-right><img src=/obscure-tutorials/img/fedora-snapper/windows-update.png></figure><p>Windows manages the files under <code>C:\Windows\System32</code> and prevents the user from modifying them with loose technical restrictions imposed by Windows Explorer. Applications like <code>notepad.exe</code> and all the various dynamically-linked libraries Windows comes with are not meant to be edited. This provides a stable and predictable system, carefully managed by Windows Update.</p><p>On Windows, anything outside of this can be installed to various user- and administrator-controlled folders like <code>C:\Program Files</code> or <code>%appdata%</code>. The analogue to this in Silverblue are the various mutable directories that are attached to <code>/var</code>, such as <code>/home/</code>, <code>/home/foo/.local/bin/</code>, <code>/var/lib/flatpak/</code>, <code>/etc/</code></p><p>It should be noted that Windows Update is <em>not</em> a true immutable system, and has numerous disadvantages compared to a true immutable system, which are discussed below. But like Windows Update, Silverblue provides the benefit of being able to rollback to the last working system files if something breaks.</p><h3 id=rpm-ostree>rpm-ostree?
<a class=anchor href=#rpm-ostree>#</a></h3><figure class=align-right><img src=/obscure-tutorials/img/fedora-snapper/fedora-silverblue.png></figure><p>Continuing with the Windows analogy, sometimes a program wants to make deeper changes to the system. It can screw with <code>.dll</code> files and add <code>.sys</code> driver files to the <code>Windows</code> folder, which is a clunky but ultimately effective way to modify the Windows system. But it&rsquo;s not great, on Windows you don&rsquo;t have a vetted distribution that is <em>designed</em> to work with the base files, rather you have some possibly-broken drivers distributed by a vendor that doesn&rsquo;t care if they break your system.</p><p><a href=https://rpm-ostree.readthedocs.io/en/stable/><code>rpm-ostree</code></a> is the analogue to this in Fedora Silverblue. It uses some special Linux kernel filesystem features to overlay extra files on top of the immutable base system. It can even be used to install out-of-tree drivers such as the NVidia drivers distributed from RPMFusion.</p><p>Generally <code>rpm-ostree</code> works pretty well. The reason <code>rpm-ostree</code> works so well is that the original system snapshot is constructed from an amalgamation of rpms from the Fedora distribution, and <code>rpm-ostree</code> is designed to be aware of how the original snapshot was constructed. It&rsquo;s quite an elegant solution!</p><h3 id=flatpak>Flatpak?
<a class=anchor href=#flatpak>#</a></h3><p>Flatpak is an incredible innovation in the Linux desktop space — it is an alternative way to install Linux desktop software that serves to alleviate deficiencies in the usual Linux distro model. In the Windows analogy, it is <code>C:\Program Files</code>, but much more sophisticated.</p><p>There are numerous benefits of Flatpak:</p><ul><li>It provides numerous security guarantees and an Android-like permission system. Flatpak (or another isolation technology) is absolutely essential for desktop Linux to be secure.</li><li>It provides developer-to-user distribution. This is not always what we want — Linux distros maintain an adversarial relationship with upstream developers, and this is by design — it is a check on developers. Distros can patch stuff and make packages more compatible and cohesive with each other. But most of the time, the end user just wants fast updates, which Flatpak can do because software is published directly by the author.</li><li>It provides consistent runtime libraries, meaning less DLL hell.</li><li>It works well with immutable systems like Silverblue and Valve SteamOS, because it doesn&rsquo;t modify the base system like <code>rpm-ostree</code> does, and can carry libraries that are separate from the base system, while still having great integration with the platform.</li></ul><p>So given the first three benefits, we should probably be using Flatpak to install certain applications, regardless of whether we&rsquo;re using Silverblue or normal Fedora. Later in the tutorial we will be installing Firefox using Flatpak.</p><p><strong>Now that we&rsquo;re primed on the solution that OSTree, Silverblue, and Flatpak in combination presents, we&rsquo;ll explore the Linux Ricing subculture and their requirements, which is the topic of this tutorial.</strong></p><h3 id=linux-ricers-and-ridding-your-system-of-bloat>Linux Ricers, and ridding your system of bloat
<a class=anchor href=#linux-ricers-and-ridding-your-system-of-bloat>#</a></h3><p>There is <a href="https://old.reddit.com/r/unixporn/top/?t=year">a subculture of the Linux community</a> that wishes to completely customize their Linux system from the ground up. They are terrified of bloat & extra software that is not needed. So they have specific requirements and either run into issues with Silverblue, or more likely immutable Linux systems just weren&rsquo;t marketed to them in the first place.</p><h4 id=silverblue-problem-1-limited-to-gnome-and-kde>Silverblue Problem #1: Limited to GNOME and KDE
<a class=anchor href=#silverblue-problem-1-limited-to-gnome-and-kde>#</a></h4><p>The Silverblue OSTree distributions are only available in two flavors, GNOME and KDE. Don&rsquo;t want GNOME&rsquo;s <code>gedit</code> text editor? You could use <code>rpm-ostree</code> to remove it — this will mask the files from appearing, but they are still stored. But if you wanted to remove hundreds of GNOME packages, <code>rpm-ostree</code> will have to maintain a list of thousands of files to mask.</p><p>Linux ricers are often not using GNOME or KDE, they usually want to start from scratch using basic Xorg or Wayland wlroots-based software. They want to be able to directly manipulate a <code>.xinitrc</code> script. After freeing themselves of bloat, they want to install an assortment of &ldquo;unix philosophy&rdquo; system-level software that doesn&rsquo;t easily fit into the Flatpak way of doing things.</p><figure class=align-right><img src=/obscure-tutorials/img/fedora-snapper/arch-i3.png></figure><p>This is why they are often using Archlinux, Gentoo, NixOS, Debian, and Voidlinux. These OSes plunge you into a command line so you can edit some text files to start a computing setup that you will hopefully be using for years. These are great operating systems, but they are not Fedora — they aren&rsquo;t keeping up with the innovation in the Linux desktop space (except for NixOS perhaps), and at the same time they aren&rsquo;t always so stable.</p><h4 id=silverblue-problem-2-rollbacks--updates-only-somewhat-help-you-fix-etc-mdash-its-handling-of-etc-is-not-time-machine-snapshots>Silverblue Problem #2: Rollbacks & updates only somewhat help you fix <code>/etc/</code> — its handling of <code>/etc</code> is not time machine snapshots
<a class=anchor href=#silverblue-problem-2-rollbacks--updates-only-somewhat-help-you-fix-etc-mdash-its-handling-of-etc-is-not-time-machine-snapshots>#</a></h4><p>Each time you switch to a different snapshot, OSTree will do a three-way diff based merge on <code>/etc/</code> to update its contents. If this three-way diff fails, you could get an <code>/etc/</code> that is broken. A Linux ricer may wish to have their system packages and their <code>/etc/</code> folder always in sync with the backup snapshots.</p><figure class=align-right><img src=/obscure-tutorials/img/fedora-snapper/windows-vista-nightmare.jpg><figcaption><h4>No, Silverblue won't give you this.</h4></figcaption></figure><h4 id=silverblue-problem-3-reboots-required>Silverblue Problem #3: Reboots required
<a class=anchor href=#silverblue-problem-3-reboots-required>#</a></h4><p>It&rsquo;s not rational of course, but Linux ricers care about uptime. They know when a reboot is actually required vs. when the software is just being cautious. Fedora Silverblue requires reboots to make changes to <code>rpm-ostree</code>. Thankfully it does not have a Windows Vista style loading screen (it&rsquo;s very quick to switch out the old snapshot for the new one) but still, it would be nice to only need to do this for rollbacks and new kernels.</p><div class=clearfix><h2 id=snapper>Snapper
<a class=anchor href=#snapper>#</a></h2><figure class=align-right><img src=/obscure-tutorials/img/fedora-snapper/btrfs-opensuse.png></figure><p><a href=https://doc.opensuse.org/documentation/leap/reference/html/book-reference/cha-snapper.html>Snapper</a> is an <a href=https://en.wikipedia.org/wiki/OpenSUSE>OpenSUSE</a> technology. OpenSUSE uses the Btrfs filesystem by default, which has copy-on-write and snapshots. Filesystem-level snapshots give you the capability to take a set of files and create a copy of it that doesn&rsquo;t actually take up any extra space, until one version of the files is modified and diverges from the original.</p><p>Snapper puts the entire system into a Btrfs subvolume, and has hooks in tools like the package manager and YaST to automatically create a Btrfs snapshot every time you install a package or update the system.</p><p>For Linux ricers, their entire root filesystem is not just a set of changes from a base image (ala Silverblue), but rather is a constantly evolving system as they change customizations over the years. So Snapper is the perfect solution to have whole-system rollback capabilities on a heavily customized Linux desktop.</p><h2 id=tutorial-set-up-a-fedora-minimal-installation-with-snapper>Tutorial: Set up a Fedora Minimal installation with Snapper
<a class=anchor href=#tutorial-set-up-a-fedora-minimal-installation-with-snapper>#</a></h2><aside class=warning><img src=/obscure-tutorials/img/icons/report.svg width=24px class=warning-icon><p>This is an advanced tutorial intended for Linux enthusaists. This process has been tested for <strong>Fedora 36</strong> and <strong>Fedora 37</strong>. Other versions may not work! Adjust your procedure if you run into issues.</p></aside><p>This is a tutorial for those who wish to start with a minimal Fedora installation and set up minimalistic X11 window managers, all while having Snapper for whole-system rollback capabilities.</p><p>Download the &ldquo;Everything&rdquo; installation medium from the <a href=https://alt.fedoraproject.org/>alternate downloads page</a> for Fedora Linux. If you are not looking to create a minimal installation, you can just get Workstation or any of the other spins.</p><figure><img src=/obscure-tutorials/img/fedora-snapper/0-everything-download.png></figure><p>Boot the medium, select a language. Click on <code>Software Selection</code>.</p><p>If you are not interested in setting up a minimal installation, you can skip this step.</p><figure><img src=/obscure-tutorials/img/fedora-snapper/1-install-selection.png></figure><p>Select <code>Minimal Install</code> and add <code>Common NetworkManager Submodules</code> (will help you get Wifi working with <code>nmcli</code> or <code>nmtui</code> later on) and <code>Standard</code>.</p><figure><img src=/obscure-tutorials/img/fedora-snapper/2-install-selection-page.png></figure><p>Click <code>Installation Destination</code>.</p><figure><img src=/obscure-tutorials/img/fedora-snapper/3-install-destination.png></figure><p>Click <code>Advanced Custom (Blivet-GUI)</code> and press <code>Done</code>.</p><figure><img src=/obscure-tutorials/img/fedora-snapper/4-install-blivet.png></figure><p>Verify that you are installing to the correct disk and click the plus icon.</p><figure><img src=/obscure-tutorials/img/fedora-snapper/5-partition-create-boot.png></figure><p>Add an EFI system partition, or a boot partition. If using UEFI, use the following configuration:</p><pre tabindex=0><code>Size: 512 MiB
Filesystem: EFI System Partition
Mountpoint: /boot/efi
</code></pre><p>If using legacy boot, consider upping the size to 1 to 2 GiB, because Snapper will put multiple different kernel images on this partition:</p><pre tabindex=0><code>Size: 1536 MiB 
Filesystem: ext4
Mountpoint: /boot
</code></pre><figure><img src=/obscure-tutorials/img/fedora-snapper/6-partition-create-boot-2.png></figure><p>Add another partition.</p><figure><img src=/obscure-tutorials/img/fedora-snapper/7-partition-create-btrfs.png></figure><p>Using the following configuration, fill the rest of the available space:</p><pre tabindex=0><code>Device Type: Btrfs Volume
Mountpoint: /
</code></pre><figure><img src=/obscure-tutorials/img/fedora-snapper/8-partition-create-btrfs-2.png></figure><p>On the left column, click on the Btrfs subvolume you just created.</p><figure><img src=/obscure-tutorials/img/fedora-snapper/9-configure-subvolumes.png></figure><p>Create a subvolume to store Snapper snapshots. Name it <code>snapper</code> and let its mountpoint be <code>/.snapshots</code></p><figure><img src=/obscure-tutorials/img/fedora-snapper/10-create-snapshots-volume.png></figure><p>After this, you should create four other subvolumes, so there should be:</p><pre tabindex=0><code>(This is the one you just created)
Name: snapshots
Mountpoint: /.snapshots
</code></pre><pre tabindex=0><code>Name: home
Mountpoint: /home
</code></pre><pre tabindex=0><code>Name: var-cache
Mountpoint: /var/cache
</code></pre><pre tabindex=0><code>Name: var-tmp
Mountpoint: /var/tmp
</code></pre><pre tabindex=0><code>Name: var-log
Mountpoint: /var/log
</code></pre><pre tabindex=0><code>Name: plocate-data
Mountpoint: /var/lib/plocate
</code></pre><p><strong>Optional:</strong> add these subvolumes for developer tools that store large amounts of frequently-updating data:</p><p>If you want to use libvirt and create virtual machine disk images</p><pre tabindex=0><code>Name: libvirt-data
Mountpoint: /var/lib/libvirt
</code></pre><p>If you use the MySQL database software</p><pre tabindex=0><code>Name: mysql-data
Mountpoint: /var/lib/mysql
</code></pre><p>If you use the MariaDB database sotware</p><pre tabindex=0><code>Name: mariadb-data
Mountpoint: /var/lib/mariadb
</code></pre><p>If you use the PostgreSQL database software</p><pre tabindex=0><code>Name: pgsql-data
Mountpoint: /var/lib/pgsql
</code></pre><p>If you use Redis key-value store software</p><pre tabindex=0><code>Name: redis-data
Mountpoint: /var/lib/redis
</code></pre><p>If you use Docker containerization software</p><pre tabindex=0><code>Name: docker-data
Mountpoint: /var/lib/docker
</code></pre><p>If you use Docker containerization software, or anything else that uses <code>containerd</code></p><pre tabindex=0><code>Name: containerd-data
Mountpoint: /var/lib/containerd
</code></pre><p>If you use lxd containerization software</p><pre tabindex=0><code>Name: lxd-data
Mountpoint: /var/lib/lxd
</code></pre><p>If you use Toolbox or Podman</p><pre tabindex=0><code>Name: containers-data
Mountpoint: /var/lib/containers
</code></pre><p>If you use the <code>/srv</code> directory</p><pre tabindex=0><code>Name: srv
Mountpoint: /srv
</code></pre><p>You can always create these subvolumes later.</p><p>Alternatively, you might consider putting the entire <code>/var</code> folder on a separate subvolume, but by doing this you won&rsquo;t include the Flatpak folder <code>/var/lib/flatpak</code> in the Snapper rollbacks.</p><p>The reason for all these subvolumes is to ensure Snapper is ignoring temporary files and other stuff that is changing constantly. We don&rsquo;t need these to be considered part of the system state that Snapper needs to preserve.</p><p>Here is what the final result should look like:</p><figure><img src=/obscure-tutorials/img/fedora-snapper/11-final-subvolumes.png></figure><p>Click <code>Done</code> after you have verified everything is correct. Click <code>Accept Changes</code> to continue.</p><figure><img src=/obscure-tutorials/img/fedora-snapper/12-finish-partitioning.png></figure><figure><img src=/obscure-tutorials/img/fedora-snapper/13-finish-partitioning-2.png></figure><p>Create any accounts you need, and configure anything else you might need to change in the installation.</p><figure><img src=/obscure-tutorials/img/fedora-snapper/14-create-accounts.png></figure><p>Begin the installation.</p><figure><img src=/obscure-tutorials/img/fedora-snapper/15-begin-installation.png></figure><figure><img src=/obscure-tutorials/img/fedora-snapper/16-installation-progress.png></figure><p>You have now installed a minimal Fedora setup!</p><h3 id=ssh-daemon-optional>SSH daemon [OPTIONAL]
<a class=anchor href=#ssh-daemon-optional>#</a></h3><p>When starting out on a newly set up minimal installation, you should probably ssh in from another PC rather than using the clunky Linux console. You can disable this later when you are done.</p><p>Assign a hostname:</p><pre tabindex=0><code># sudo hostnamectl set-hostname foobar
</code></pre><p>Start sshd:</p><pre tabindex=0><code># sudo systemctl start sshd
# sudo systemctl enable sshd
</code></pre><p>To show LAN IP:</p><pre tabindex=0><code># ip addr
</code></pre><figure><img src=/obscure-tutorials/img/fedora-snapper/17-sshd-and-ip-addr.png></figure><h3 id=shell-ricing-optional>Shell ricing [OPTIONAL]
<a class=anchor href=#shell-ricing-optional>#</a></h3><p>Before we start, lets install some dependencies to get a nice comfortable zsh-based shell:</p><pre tabindex=0><code># sudo dnf install zsh fzf PackageKit-command-not-found util-linux-user sqlite git
</code></pre><aside class=warning><img src=/obscure-tutorials/img/icons/report.svg width=24px class=warning-icon><p>Ignore the command in the screenshot below, use the fixed command above</p></aside><figure><img src=/obscure-tutorials/img/fedora-snapper/18-shell-dependencies.png></figure><p>Install <a href=https://github.com/zplug/zplug><code>zplug</code></a>, an easy scripts manager for <code>zsh</code>:</p><pre tabindex=0><code># curl -sL --proto-redir -all,https https://raw.githubusercontent.com/zplug/installer/master/installer.zsh | zsh
</code></pre><p>Run <code>chsh</code> and set the shell to <code>/usr/bin/zsh</code>. Log out and log back in.</p><figure><img src=/obscure-tutorials/img/fedora-snapper/19-shell-zplug.png></figure><p>Save the following to <code>~/.zshrc</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-zsh data-lang=zsh><span style=display:flex><span><span style=color:#f92672>[[</span> -f ~/.profile <span style=color:#f92672>]]</span> <span style=color:#f92672>&amp;&amp;</span> source ~/.profile
</span></span><span style=display:flex><span>source ~/.zplug/init.zsh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>zplug themes/dpoggi, from:oh-my-zsh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> ! zplug check --verbose; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>    printf <span style=color:#e6db74>&#34;Install? [y/N]: &#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> read -q; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>        echo; zplug install
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>zplug load
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>source /usr/share/fzf/shell/key-bindings.zsh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HISTFILE<span style=color:#f92672>=</span>~/.zsh_history
</span></span><span style=display:flex><span>HISTSIZE<span style=color:#f92672>=</span><span style=color:#ae81ff>100000000</span>
</span></span><span style=display:flex><span>SAVEHIST<span style=color:#f92672>=</span><span style=color:#ae81ff>100000000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>bindkey -e
</span></span><span style=display:flex><span>bindkey <span style=color:#e6db74>&#34;^[[1;5C&#34;</span> forward-word
</span></span><span style=display:flex><span>bindkey <span style=color:#e6db74>&#34;^[[1;5D&#34;</span> backward-word
</span></span><span style=display:flex><span>bindkey <span style=color:#e6db74>&#34;^H&#34;</span> backward-kill-word
</span></span><span style=display:flex><span>bindkey <span style=color:#e6db74>&#34;^[[3;5~&#34;</span> kill-word
</span></span><span style=display:flex><span>setopt BANG_HIST
</span></span><span style=display:flex><span>setopt EXTENDED_HISTORY
</span></span><span style=display:flex><span>setopt INC_APPEND_HISTORY
</span></span><span style=display:flex><span>setopt SHARE_HISTORY
</span></span><span style=display:flex><span>setopt HIST_EXPIRE_DUPS_FIRST
</span></span><span style=display:flex><span>setopt HIST_IGNORE_DUPS
</span></span><span style=display:flex><span>setopt HIST_IGNORE_ALL_DUPS
</span></span><span style=display:flex><span>setopt HIST_FIND_NO_DUPS
</span></span><span style=display:flex><span>setopt HIST_IGNORE_SPACE
</span></span><span style=display:flex><span>setopt HIST_SAVE_NO_DUPS
</span></span><span style=display:flex><span>setopt HIST_REDUCE_BLANKS
</span></span><span style=display:flex><span>setopt HIST_VERIFY
</span></span><span style=display:flex><span>setopt HIST_BEEP
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>autoload -Uz compinit
</span></span><span style=display:flex><span>compinit
</span></span><span style=display:flex><span>autoload -U bashcompinit
</span></span><span style=display:flex><span>bashcompinit
</span></span></code></pre></div><p>We have a nice shell now, much more pleasant than the bash defaults. Feel free to add on to the <code>zplug</code> config.</p><h3 id=installing-snapper-and-setting-up-grub-integration>Installing Snapper and setting up Grub integration
<a class=anchor href=#installing-snapper-and-setting-up-grub-integration>#</a></h3><p>We can inspect how the subvolumes are set up:</p><pre tabindex=0><code># sudo btrfs subvolume list /
# sudo btrfs filesystem show /
# sudo lsblk -p
# cat /etc/fstab
</code></pre><p><code>/etc/fstab</code> contents example:</p><aside class=warning><img src=/obscure-tutorials/img/icons/report.svg width=24px class=warning-icon><p>There is no need to modify any of this right now, this is just an sanity check to see what the Fedora installer has created.</p></aside><pre tabindex=0><code class=language-fstab data-lang=fstab>UUID=FD87-791A          /boot/efi               vfat    umask=0077,shortname=winnt 0 2
UUID=9f2ebb76-0cc0-4473-9c82-2856500e1d22 /                       btrfs   defaults        0 0
UUID=9f2ebb76-0cc0-4473-9c82-2856500e1d22 /.snapshots             btrfs   subvol=snapshots,compress=zstd:1 0 0
UUID=9f2ebb76-0cc0-4473-9c82-2856500e1d22 /home                   btrfs   subvol=home,compress=zstd:1 0 0
UUID=9f2ebb76-0cc0-4473-9c82-2856500e1d22 /srv                    btrfs   subvol=srv,compress=zstd:1 0 0
UUID=9f2ebb76-0cc0-4473-9c82-2856500e1d22 /var/cache              btrfs   subvol=var-cache,compress=zstd:1 0 0
UUID=9f2ebb76-0cc0-4473-9c82-2856500e1d22 /var/lib/containerd     btrfs   subvol=containerd-data,compress=zstd:1 0 0
UUID=9f2ebb76-0cc0-4473-9c82-2856500e1d22 /var/lib/containers     btrfs   subvol=containers-data,compress=zstd:1 0 0
UUID=9f2ebb76-0cc0-4473-9c82-2856500e1d22 /var/lib/docker         btrfs   subvol=docker-data,compress=zstd:1 0 0
UUID=9f2ebb76-0cc0-4473-9c82-2856500e1d22 /var/lib/libvirt        btrfs   subvol=libvirt-data,compress=zstd:1 0 0
UUID=9f2ebb76-0cc0-4473-9c82-2856500e1d22 /var/lib/lxd            btrfs   subvol=lxd-data,compress=zstd:1 0 0
UUID=9f2ebb76-0cc0-4473-9c82-2856500e1d22 /var/lib/mariadb        btrfs   subvol=mariadb-data,compress=zstd:1 0 0
UUID=9f2ebb76-0cc0-4473-9c82-2856500e1d22 /var/lib/mysql          btrfs   subvol=mysql-data,compress=zstd:1 0 0
UUID=9f2ebb76-0cc0-4473-9c82-2856500e1d22 /var/lib/pgsql          btrfs   subvol=pgsql-data,compress=zstd:1 0 0
UUID=9f2ebb76-0cc0-4473-9c82-2856500e1d22 /var/lib/plocate        btrfs   subvol=plocate-data,compress=zstd:1 0 0
UUID=9f2ebb76-0cc0-4473-9c82-2856500e1d22 /var/log                btrfs   subvol=var-log,compress=zstd:1 0 0
UUID=9f2ebb76-0cc0-4473-9c82-2856500e1d22 /var/tmp                btrfs   subvol=var-tmp,compress=zstd:1 0 0
</code></pre><figure><img src=/obscure-tutorials/img/fedora-snapper/20-btrfs-subvolumes-check.png></figure><p>If your setup looks roughly like this, you can continue.</p><p>First, if you created these, you may wish to configure some of the heaviest <code>/var/</code> subvolumes to disable copy-on-write. Some database software doesn&rsquo;t play well with it and causes performance issues.</p><pre tabindex=0><code># sudo chattr -R +C /var/lib/libvirt
# sudo chattr -R +C /var/lib/mysql
# sudo chattr -R +C /var/lib/mariadb
# sudo chattr -R +C /var/lib/pgsql
</code></pre><figure><img src=/obscure-tutorials/img/fedora-snapper/21-nocow.png></figure><p>Allow for snapshot booting by editing <code>/etc/default/grub</code>. Add the following line:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>SUSE_BTRFS_SNAPSHOT_BOOTING<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;true&#34;</span>
</span></span></code></pre></div><p>Update grub configuration to reflect this change:</p><pre tabindex=0><code># sudo grub2-mkconfig -o /boot/grub2/grub.cfg
</code></pre><figure><img src=/obscure-tutorials/img/fedora-snapper/22-mkconfig.png></figure><p>Reboot:</p><pre tabindex=0><code># sudo reboot
</code></pre><p>Install Snapper, and the <code>dnf</code> hooks for automatically creating before/after snapshots every time packages are changed:</p><pre tabindex=0><code># sudo dnf install snapper python3-dnf-plugin-snapper inotify-tools
</code></pre><figure><img src=/obscure-tutorials/img/fedora-snapper/23-install-snapper.png></figure><p>Delete and recreate the <code>/.snapper</code> subvolume to get snapper to take over it.</p><pre tabindex=0><code># sudo umount /.snapshots
# sudo rmdir /.snapshots
# sudo snapper -c root create-config /
# sudo btrfs subvolume delete /.snapshots
# sudo mkdir /.snapshots
</code></pre><figure><img src=/obscure-tutorials/img/fedora-snapper/24-remake-snapshots-subvolume.png></figure><p>Reload fstab:</p><pre tabindex=0><code># sudo systemctl daemon-reload
# sudo mount -a
</code></pre><figure><img src=/obscure-tutorials/img/fedora-snapper/25-remount-snapshots-subvolume.png></figure><p>You can verify that the subvolume is mounted correctly:</p><pre tabindex=0><code># lsblk -p
</code></pre><p>Configure Snapper to allow your account to administrate it:</p><pre tabindex=0><code># sudo snapper -c root set-config ALLOW_USERS=$USER SYNC_ACL=yes
# sudo chown -R :$USER /.snapshots
</code></pre><figure><img src=/obscure-tutorials/img/fedora-snapper/26-take-ownership-of-snapshots.png></figure><p>Unhide the grub menu:</p><pre tabindex=0><code># sudo grub2-editenv - unset menu_auto_hide
</code></pre><p>Install <code>grub-btrfs</code>, a tool to automatically generate grub listings for Snapper snapshots. This is a script that works transparently to update grub every time <code>/.snapshots</code> is modified, similar to how OpenSUSE works.</p><pre tabindex=0><code># sudo dnf install make
# git clone https://github.com/Antynea/grub-btrfs.git /tmp/grub-btrfs
# cd /tmp/grub-btrfs
# sudo make install
</code></pre><figure><img src=/obscure-tutorials/img/fedora-snapper/27-install-grub-btrfs.png></figure><p>Edit the config file for <code>grub-btrfs</code> at <code>/etc/default/grub-btrfs/config</code>.</p><p><strong>Edit #1:</strong> Make sure <code>GRUB_BTRFS_MKCONFIG</code> is uncommented and set to <code>/usr/sbin/grub2-mkconfig</code></p><aside class=warning><img src=/obscure-tutorials/img/icons/report.svg width=24px class=warning-icon><p>That is <code>/usr/sbin</code>, not <code>/usr/bin</code>!</p></aside><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>GRUB_BTRFS_MKCONFIG<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/usr/sbin/grub2-mkconfig&#34;</span>
</span></span></code></pre></div><p><strong>Edit #2:</strong> Make sure <code>GRUB_BTRFS_SCRIPT_CHECK</code> is uncommented and set to <code>grub2-script-check</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>GRUB_BTRFS_SCRIPT_CHECK<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;grub2-script-check&#34;</span>
</span></span></code></pre></div><p><strong>Edit #3:</strong> Make sure <code>GRUB_BTRFS_GRUB_DIRNAME</code> is uncommented and set to <code>/boot/grub2</code>. Do not follow the Fedora advice in the commented out section, it is meant for Fedora 33 and earlier.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>GRUB_BTRFS_GRUB_DIRNAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/boot/grub2&#34;</span>
</span></span></code></pre></div><p>In patch format:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#f92672>--- /tmp/a
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ /tmp/b
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -90,7 +90,7 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> # Might be grub2 on some systems.
</span></span><span style=display:flex><span> # For example, on Fedora with EFI : &#34;/boot/efi/EFI/fedora&#34;
</span></span><span style=display:flex><span> # Default: &#34;/boot/grub&#34;
</span></span><span style=display:flex><span><span style=color:#f92672>-#GRUB_BTRFS_GRUB_DIRNAME=&#34;/boot/grub2&#34;
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+GRUB_BTRFS_GRUB_DIRNAME=&#34;/boot/grub2&#34;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> 
</span></span><span style=display:flex><span> # Location of kernels/initramfs/microcode.
</span></span><span style=display:flex><span> # Use by &#34;grub-btrfs&#34; to detect the boot partition and the location of kernels/initrafms/microcodes.
</span></span><span style=display:flex><span><span style=color:#75715e>@@ -104,13 +104,13 @@
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> # For example, on Fedora : &#34;/sbin/grub2-mkconfig&#34;
</span></span><span style=display:flex><span> # You can use only name or full path.
</span></span><span style=display:flex><span> # Default: grub-mkconfig
</span></span><span style=display:flex><span><span style=color:#f92672>-#GRUB_BTRFS_MKCONFIG=/usr/bin/grub2-mkconfig
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+GRUB_BTRFS_MKCONFIG=&#34;/usr/sbin/grub2-mkconfig&#34;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> 
</span></span><span style=display:flex><span> # Name of grub-script-check command, use by &#34;grub-btrfs&#34;
</span></span><span style=display:flex><span> # Might be &#39;grub2-script-check&#39; on some systems (Fedora ...)
</span></span><span style=display:flex><span> # For example, on Fedora : &#34;grub2-script-check&#34;
</span></span><span style=display:flex><span> # Default: grub-script-check
</span></span><span style=display:flex><span><span style=color:#f92672>-#GRUB_BTRFS_SCRIPT_CHECK=grub2-script-check
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+GRUB_BTRFS_SCRIPT_CHECK=&#34;grub2-script-check&#34;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> 
</span></span><span style=display:flex><span> # Path of grub-mkconfig_lib file, use by &#34;grub-btrfs&#34;
</span></span><span style=display:flex><span> # Might be &#39;/usr/share/grub2/grub-mkconfig_lib&#39; on some systems (Opensuse ...)
</span></span></code></pre></div><p>Once you are done, regenerate the grub config and enable the systemd unit for watching <code>/.snapshots</code> in real time:</p><pre tabindex=0><code># sudo grub2-mkconfig -o /boot/grub2/grub.cfg
# sudo systemctl enable --now grub-btrfsd.service
</code></pre><figure><img src=/obscure-tutorials/img/fedora-snapper/28-setup-grub-btrfs.png></figure><h3 id=using-snapper>Using Snapper
<a class=anchor href=#using-snapper>#</a></h3><p>Success, you have now installed Snapper! You can use <code>snapper ls</code> to see the snapshots it has created:</p><figure><img src=/obscure-tutorials/img/fedora-snapper/29-snapper-example.png></figure><p>A snapshot will be generated every time you run a <code>dnf</code> command that changes the system. You can access these snapshots from the grub menu.</p><p>By selecting this, you will boot into a read-only system where you can verify your system is in a working state before switching to it. As an example, we rollback to a snapshot before <code>htop</code> was installed:</p><p><figure><img src=/obscure-tutorials/img/fedora-snapper/30-grub-menu.png></figure><figure><img src=/obscure-tutorials/img/fedora-snapper/31-grub-menu.png></figure><figure><img src=/obscure-tutorials/img/fedora-snapper/32-grub-menu.png></figure></p><p><code>htop</code> is gone:</p><figure><img src=/obscure-tutorials/img/fedora-snapper/33-no-more-htop.png></figure><p>To rollback to it, you can run this command, where <code>&lt;NUM></code> is the id number of the snapshot you wish to return to. You can use <code>--ambit classic</code> to switch to a read-write copy of the chosen snapshot. <code>--ambit transactional</code> is equivalent to selecting the read-only grub entry.</p><pre tabindex=0><code># snapper --ambit classic rollback &lt;NUM&gt;
</code></pre><p>Refer to the <a href=https://en.opensuse.org/openSUSE:Snapper_Tutorial>official Snapper Tutorial</a> for advanced usage.</p><h3 id=ricing-an-x11-desktop-optional>Ricing an X11 desktop [OPTIONAL]
<a class=anchor href=#ricing-an-x11-desktop-optional>#</a></h3><p>Now that we have a minimal Fedora setup, we can start installing things. In this example we&rsquo;ll install SDDM with Openbox and Polybar. First we&rsquo;ll be using some package groups to make the basics easy:</p><pre tabindex=0><code># sudo dnf install @base-x &#34;@Hardware Support&#34; &#34;@Fonts&#34; &#34;@Input Methods&#34; &#34;@Multimedia&#34; &#34;@Printing Support&#34;
</code></pre><p>Then we install the meat of what we want:</p><pre tabindex=0><code># sudo dnf install sddm polybar openbox lxappearance lxappearance-obconf obconf picom
</code></pre><p>We&rsquo;ll grab some themes:</p><pre tabindex=0><code># sudo dnf install sddm-themes arc-theme arc-kde lxappearance feh
</code></pre><p>Install some applications:</p><pre tabindex=0><code># sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
# sudo flatpak install org.mozilla.firefox
# sudo dnf install kitty neofetch
</code></pre><p>Add autostart script for Openbox at <code>~/.config/openbox/autostart</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>picom &amp;
</span></span><span style=display:flex><span>polybar &amp;
</span></span><span style=display:flex><span>feh --bg-scale /usr/share/backgrounds/f37/default/f37-02-night.png &amp;
</span></span></code></pre></div><p>Start sddm on boot:</p><pre tabindex=0><code>sudo systemctl enable sddm
sudo systemctl start sddm
sudo systemctl set-default graphical.target
</code></pre><figure><img src=/obscure-tutorials/img/fedora-snapper/34-rice.png></figure><hr><p>© lordpipe</p><p>Licensed CC BY — copy this document for your own use.</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#snapper-but-what-about-silverblue>Snapper? But what about Silverblue?</a><ul><li><a href=#rpm-ostree>rpm-ostree?</a></li><li><a href=#flatpak>Flatpak?</a></li><li><a href=#linux-ricers-and-ridding-your-system-of-bloat>Linux Ricers, and ridding your system of bloat</a></li></ul></li><li><a href=#snapper>Snapper</a></li><li><a href=#tutorial-set-up-a-fedora-minimal-installation-with-snapper>Tutorial: Set up a Fedora Minimal installation with Snapper</a><ul><li><a href=#ssh-daemon-optional>SSH daemon [OPTIONAL]</a></li><li><a href=#shell-ricing-optional>Shell ricing [OPTIONAL]</a></li><li><a href=#installing-snapper-and-setting-up-grub-integration>Installing Snapper and setting up Grub integration</a></li><li><a href=#using-snapper>Using Snapper</a></li><li><a href=#ricing-an-x11-desktop-optional>Ricing an X11 desktop [OPTIONAL]</a></li></ul></li></ul></nav></div></aside></main></body></html>